<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>DivTube | Infinite Sovereignty</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg: #0b0e14; --sidebar: #151921; --card: #1c212c;
            --text-main: #f8fafc; --text-dim: #94a3b8;
            --primary: #8b5cf6; --accent: #d8b4fe; --border: rgba(255,255,255,0.08);
            --success: #10b981;
        }

        * { box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { margin: 0; background: var(--bg); color: var(--text-main); display: flex; height: 100vh; overflow: hidden; }
        
        aside { width: 280px; background: var(--sidebar); display: flex; flex-direction: column; padding: 1.5rem 1rem; border-right: 1px solid var(--border); }
        main { flex: 1; display: flex; flex-direction: column; overflow-y: auto; position: relative; scroll-behavior: smooth; }
        
        .logo-container { display: flex; align-items: center; gap: 12px; margin-bottom: 2.5rem; text-decoration: none; padding-left: 0.5rem; }
        .logo-img { width: 40px; height: 40px; border-radius: 8px; border: 2px solid var(--primary); background: var(--card); object-fit: cover; }
        .logo-text { font-weight: 800; font-size: 1.6rem; color: var(--text-main); letter-spacing: -1px; }
        
        .nav-item { padding: 0.75rem 1rem; border-radius: 10px; cursor: pointer; color: var(--text-dim); text-decoration: none; display: flex; align-items: center; gap: 12px; margin-bottom: 0.2rem; font-weight: 500; transition: 0.2s; }
        .nav-item:hover, .nav-item.active { background: rgba(139, 92, 246, 0.1); color: var(--primary); }
        
        header { padding: 1rem 2rem; display: flex; justify-content: center; background: rgba(11, 14, 20, 0.9); backdrop-filter: blur(15px); position: sticky; top: 0; z-index: 1000; border-bottom: 1px solid var(--border); }
        .search-container { width: 100%; max-width: 600px; }
        .search-container input { width: 100%; background: var(--card); border: 1px solid var(--border); padding: 0.8rem 1.5rem; border-radius: 25px; color: white; outline: none; }

        .page { display: none; padding: 2rem; max-width: 1400px; margin: 0 auto; width: 100%; animation: fadeIn 0.3s ease; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        .video-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1.5rem; }
        .video-card { background: var(--card); border-radius: 12px; overflow: hidden; border: 1px solid var(--border); cursor: pointer; transition: 0.2s; }
        .video-card:hover { transform: translateY(-4px); border-color: var(--primary); }
        .video-card img { width: 100%; aspect-ratio: 16/9; object-fit: cover; }
        .card-info { padding: 1rem; }
        .card-info h4 { margin: 0 0 0.5rem; font-size: 0.9rem; line-height: 1.4; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }

        #page-watch { display: none; grid-template-columns: 1fr 350px; gap: 2rem; }
        .player-box { width: 100%; aspect-ratio: 16/9; background: #000; border-radius: 16px; overflow: hidden; }

        .action-bar { display: flex; gap: 10px; margin-top: 15px; }
        .btn { border: 1px solid var(--border); color: white; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; transition: 0.2s; background: var(--card); }
        .btn:hover { border-color: var(--primary); background: rgba(139, 92, 246, 0.05); }
        .btn-capture { border-color: var(--success); color: var(--success); }

        .settings-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; }
        .settings-card { background: var(--card); padding: 1.5rem; border-radius: 12px; border: 1px solid var(--border); }
        .control-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        
        .tag { background: rgba(139, 92, 246, 0.1); color: var(--primary); padding: 4px 10px; border-radius: 6px; font-size: 0.75rem; font-weight: 700; display: inline-flex; align-items: center; gap: 5px; margin: 3px; }
        .switch { position: relative; display: inline-block; width: 40px; height: 20px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #334155; transition: .4s; border-radius: 20px; }
        input:checked + .slider { background-color: var(--primary); }
        .masked-thumb { filter: brightness(0.15) blur(15px); opacity: 0.4; }
        
        #ghost-mode-status { font-size: 0.65rem; padding: 2px 6px; border-radius: 4px; background: #334155; color: white; display: none; }
        .ghost-active #ghost-mode-status { display: inline; background: var(--primary); }
        .loading-sentinel { height: 50px; display: flex; align-items: center; justify-content: center; color: var(--text-dim); font-size: 0.8rem; }
    </style>
</head>
<body id="body">

<aside>
    <a href="#home" class="logo-container">
        <img src="DivTube.png" class="logo-img" alt="ü¶Å">
        <span class="logo-text">DivTube</span>
    </a>
    <nav class="nav-group">
        <a href="#home" class="nav-item" id="nav-home">üè† Neural Feed</a>
        <a href="#history" class="nav-item" id="nav-history">üïí Memory Stream</a>
        <a href="#settings" class="nav-item" id="nav-settings">‚öôÔ∏è Command Center</a>
        
        <div class="nav-item" onclick="toggleGhostMode()" style="margin-top:20px; border: 1px dashed var(--border);">
            üëª Ghost Mode <span id="ghost-mode-status">ACTIVE</span>
        </div>
    </nav>

    <div style="margin-top: auto; padding: 1rem; background: rgba(255,255,255,0.03); border-radius: 12px;">
        <div style="font-size: 0.75rem; display:flex; justify-content:space-between; margin-bottom:8px;">
            <span>ACTIVE FOCUS</span> <span id="focus-status">0m</span>
        </div>
        <div style="height:4px; background: #334155; border-radius:2px;">
            <div id="focus-bar" style="height:100%; width: 0%; background: var(--primary); transition: 0.3s;"></div>
        </div>
    </div>
</aside>

<main id="main-scroll">
    <header>
        <form class="search-container" onsubmit="executeSearch(event)">
            <input type="text" id="searchBox" placeholder="Query the intelligence...">
        </form>
    </header>

    <div id="page-home" class="page">
        <h2>Personalized Feed</h2>
        <div id="home-grid" class="video-grid"></div>
        <div class="loading-sentinel" id="home-sentinel">Scanning more intelligence...</div>
    </div>

    <div id="page-search" class="page">
        <h2 id="search-query-display">Results</h2>
        <div id="search-grid" class="video-grid"></div>
        <div class="loading-sentinel" id="search-sentinel">Retrieving more data...</div>
    </div>

    <div id="page-watch" class="page">
        <div class="watch-content">
            <div class="player-box">
                <iframe id="mainPlayer" style="width:100%; height:100%; border:none;" allow="autoplay; fullscreen"></iframe>
            </div>
            <h1 id="v-title" style="margin-top:1.5rem; font-size: 1.4rem;"></h1>
            <div class="action-bar">
                <button id="likeBtn" class="btn" onclick="handleLike()">‚ô• Like Topic</button>
                <button class="btn btn-capture" onclick="redirectToCapture()">üì∏ Capture</button>
            </div>
        </div>
        <div class="watch-sidebar">
            <h3>Neural Context</h3>
            <div id="sidebar-grid" class="video-grid" style="grid-template-columns: 1fr;"></div>
        </div>
    </div>

    <div id="page-history" class="page">
        <h2>Memory Stream</h2>
        <div id="history-list"></div>
    </div>

    <div id="page-settings" class="page">
        <h2>Command Center</h2>
        <div class="settings-grid">
            <div class="settings-card">
                <h3>üéöÔ∏è Scoring Weights</h3>
                <div class="control-row"><span>Like Bonus</span> <input type="range" id="w-like" min="1" max="50" onchange="saveConfig()"></div>
                <div class="control-row"><span>Watch Bonus</span> <input type="range" id="w-watch" min="1" max="20" onchange="saveConfig()"></div>
                <div class="control-row"><span>Bounce Penalty</span> <input type="range" id="w-bounce" min="-50" max="-1" onchange="saveConfig()"></div>
            </div>
            <div class="settings-card">
                <h3>üßò Minimalism</h3>
                <div class="control-row">
                    <span>Manual Masking</span>
                    <label class="switch"><input type="checkbox" id="mask-toggle" onchange="saveConfig()"><span class="slider"></span></label>
                </div>
            </div>
            <div class="settings-card" style="grid-column: span 2;">
                <h3>üß† Knowledge Profile (Phrases)</h3>
                <div id="tag-cloud"></div>
            </div>
        </div>
    </div>
</main>

<script>
const API_KEY = "AIzaSyAsiXire2Ls6HrwkS7tIFNqkNi5xpySeCg";

let state = {
    brain: JSON.parse(localStorage.getItem("dt_brain")) || { weights: {}, history: [], bl: [] },
    config: JSON.parse(localStorage.getItem("dt_config")) || { wLike: 20, wWatch: 8, wBounce: -15, mask: false },
    focus: parseFloat(localStorage.getItem("dt_focus")) || 0,
    ghostMode: false,
    view: 'home', 
    watchStart: null, 
    currentVid: null,
    nextPageToken: '',
    isLoading: false,
    currentQuery: '',
    lastResultSet: [] // Used for analysis
};

function router() {
    const hash = window.location.hash.slice(1) || 'home';
    const [path, query] = hash.split('?');
    const params = new URLSearchParams(query);
    
    if (state.view === 'watch' && path !== 'watch') {
        document.getElementById('mainPlayer').src = "";
    }

    state.view = path;
    state.nextPageToken = '';
    
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.getElementById(`page-${path}`)?.classList.add('active');
    document.getElementById('page-watch').style.display = (path === 'watch' ? 'grid' : 'none');
    
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
    document.getElementById(`nav-${path}`)?.classList.add('active');

    if(path === 'home') initHome();
    if(path === 'search') initSearch(params.get('q'));
    if(path === 'watch') initWatch(params.get('v'));
    if(path === 'settings') initSettings();
    if(path === 'history') initHistory();
}
window.onhashchange = router;
window.onload = router;

// --- ADVANCED NEURAL TRACKING (Phrases & Context) ---
function track(text, points) {
    if(!text || state.ghostMode) return;
    
    const clean = text.toLowerCase().replace(/[^\w\s]/gi, '').trim();
    const words = clean.split(/\s+/).filter(w => w.length > 3);
    
    // Create Tokens: Individual words + Bigrams (2-word phrases)
    let tokens = [...words];
    for (let i = 0; i < words.length - 1; i++) {
        tokens.push(`${words[i]} ${words[i+1]}`);
    }

    tokens.forEach(t => {
        if(state.brain.bl.includes(t)) return;
        // Phrases get a slight bonus multiplier for specificity
        const multiplier = t.includes(' ') ? 1.5 : 1;
        const score = Math.round(points * multiplier);
        
        state.brain.weights[t] = (state.brain.weights[t] || 0) + score;
        if(state.brain.weights[t] <= 0) delete state.brain.weights[t];
    });
    localStorage.setItem("dt_brain", JSON.stringify(state.brain));
}

// --- CORE FETCHING ENGINE ---
async function fetchYT(q, target, append = false) {
    if (state.isLoading) return;
    state.isLoading = true;
    state.currentQuery = q;

    const pageParam = state.nextPageToken ? `&pageToken=${state.nextPageToken}` : '';
    const url = `https://www.googleapis.com/youtube/v3/search?part=snippet&type=video&maxResults=12&q=${encodeURIComponent(q)}${pageParam}&key=${API_KEY}`;
    
    try {
        const res = await fetch(url);
        const data = await res.json();
        
        if (!data.items) {
            console.warn("API returned no items. Check key/quota.");
            state.isLoading = false;
            return;
        }

        state.lastResultSet = data.items;
        const container = document.getElementById(target);
        if(!container) return;

        if(!append) container.innerHTML = "";
        state.nextPageToken = data.nextPageToken || '';

        data.items.forEach(item => {
            if(!item.id.videoId) return;
            const card = document.createElement('div');
            card.className = 'video-card';
            card.innerHTML = `<img src="${item.snippet.thumbnails.medium.url}" class="${state.config.mask ? 'masked-thumb' : ''}"><div class="card-info"><h4>${item.snippet.title}</h4></div>`;
            card.onclick = () => {
                if(!state.ghostMode) {
                    state.currentVid = { title: item.snippet.title, id: item.id.videoId };
                    state.brain.history.push(state.currentVid);
                    track(item.snippet.title, 2); // Learn from what we click
                }
                window.location.hash = `#watch?v=${item.id.videoId}`;
            };
            container.appendChild(card);
        });
    } catch(e) {
        console.error("Fetch Error:", e);
    } finally {
        state.isLoading = false;
    }
}

// --- INFINITE SCROLL ---
document.getElementById('main-scroll').addEventListener('scroll', (e) => {
    if (state.view !== 'home' && state.view !== 'search') return;
    const container = e.target;
    if (container.scrollHeight - container.scrollTop <= container.clientHeight + 400) {
        if (state.nextPageToken && !state.isLoading) {
            const target = state.view === 'home' ? 'home-grid' : 'search-grid';
            fetchYT(state.currentQuery, target, true);
        }
    }
});

function initHome() {
    const sorted = Object.entries(state.brain.weights).sort((a,b)=>b[1]-a[1]);
    const topQuery = sorted.length > 0 ? sorted[0][0] : "Documentary Science";
    fetchYT(topQuery, 'home-grid');
}

async function initSearch(q) {
    if(!q) return;
    document.getElementById('search-query-display').innerText = `Results: ${q}`;
    await fetchYT(q, 'search-grid');
    
    // Result Analysis: Learn from the titles the search actually brought back
    if(!state.ghostMode && state.lastResultSet) {
        track(q, 5); // Higher weight for direct query
        state.lastResultSet.slice(0, 3).forEach(item => track(item.snippet.title, 1));
    }
}

function initWatch(id) {
    if(!id) return;
    document.getElementById('mainPlayer').src = `https://www.youtube-nocookie.com/embed/${id}?autoplay=1`;
    state.watchStart = Date.now();
    // Use last known heavy weight for sidebar
    const sorted = Object.entries(state.brain.weights).sort((a,b)=>b[1]-a[1]);
    fetchYT(sorted.length ? sorted[0][0] : "Educational", 'sidebar-grid');
}

function redirectToCapture() {
    window.open(`https://nevercap.ai/resources/youtube-to-mp4`, '_blank');
}

function executeSearch(e) { e.preventDefault(); window.location.hash = `#search?q=${document.getElementById('searchBox').value}`; }

function handleLike() {
    if(state.currentVid && !state.ghostMode) {
        track(state.currentVid.title, parseInt(state.config.wLike));
        document.getElementById('likeBtn').innerText = "‚úì Liked";
    }
}

function toggleGhostMode() {
    state.ghostMode = !state.ghostMode;
    document.getElementById('body').classList.toggle('ghost-active', state.ghostMode);
}

function initSettings() {
    const cloud = document.getElementById('tag-cloud'); cloud.innerHTML = "";
    Object.entries(state.brain.weights).sort((a,b)=>b[1]-a[1]).slice(0, 20).forEach(([w, s]) => {
        cloud.innerHTML += `<div class="tag">${w} (${s})</div>`;
    });
}

function saveConfig() {
    state.config.wLike = document.getElementById('w-like').value;
    state.config.mask = document.getElementById('mask-toggle').checked;
    localStorage.setItem("dt_config", JSON.stringify(state.config));
}

function initHistory() {
    const list = document.getElementById('history-list'); list.innerHTML = "";
    state.brain.history.slice().reverse().forEach(v => {
        list.innerHTML += `<div style="padding:10px; border-bottom:1px solid var(--border); font-size:0.9rem;">${v.title}</div>`;
    });
}

setInterval(() => {
    if(state.view === 'watch' && state.watchStart) {
        state.focus += 0.166;
        document.getElementById('focus-status').innerText = Math.round(state.focus) + "m";
        document.getElementById('focus-bar').style.width = Math.min(100, (state.focus/60)*100) + "%";
        localStorage.setItem("dt_focus", state.focus);
    }
}, 10000);
</script>
</body>
</html>
