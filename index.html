<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <title>DivTube Sovereign v26.0</title>
    <script type="module" src="https://pyscript.net/releases/2024.1.1/core.js" defer></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&family=JetBrains+Mono&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #010204; --sidebar: #06080c; --card: #0c0f16;
            --primary: #8b5cf6; --text: #f1f5f9; --border: rgba(255,255,255,0.06);
            --accent: #10b981; --warn: #ef4444; --sub: #f59e0b;
        }
        * { box-sizing: border-box; font-family: 'Inter', sans-serif; transition: 0.2s; }
        body { margin: 0; background: var(--bg); color: var(--text); display: flex; height: 100vh; overflow: hidden; }
        
        aside { width: 260px; background: var(--sidebar); border-right: 1px solid var(--border); padding: 1.5rem; display: flex; flex-direction: column; z-index: 100; }
        .logo { font-weight: 900; font-size: 1.8rem; color: var(--primary); letter-spacing: -2px; cursor: pointer; margin-bottom: 2rem; }
        .nav-item { padding: 12px; border-radius: 12px; cursor: pointer; color: rgba(255,255,255,0.4); font-weight: 700; display: flex; align-items: center; gap: 10px; margin-bottom: 5px; text-decoration: none; font-size: 0.9rem; }
        .nav-item.active { background: rgba(139, 92, 246, 0.15); color: var(--primary); border: 1px solid rgba(139, 92, 246, 0.2); }

        main { flex: 1; overflow-y: auto; background: radial-gradient(circle at top right, #0d1117, #010204); }
        .view { display: none; padding: 2rem; max-width: 1400px; margin: 0 auto; animation: fadeIn 0.3s ease; }
        .active-view { display: block; }

        /* Video Styles */
        .video-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1.5rem; }
        .card { background: var(--card); border-radius: 20px; overflow: hidden; border: 1px solid var(--border); cursor: pointer; position: relative; }
        .card img { width: 100%; aspect-ratio: 16/9; object-fit: cover; }
        .badge { position: absolute; top: 10px; left: 10px; padding: 4px 10px; border-radius: 50px; font-size: 9px; font-weight: 900; backdrop-filter: blur(4px); }
        .badge-sub { background: rgba(245, 158, 11, 0.2); color: var(--sub); border: 1px solid var(--sub); }

        /* Modal */
        #modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.9); backdrop-filter: blur(15px); display: none; z-index: 5000; align-items: center; justify-content: center; padding: 20px; }
        #modal-content { background: var(--bg); width: 100%; max-width: 1000px; border-radius: 30px; border: 1px solid var(--border); padding: 2.5rem; max-height: 90vh; overflow-y: auto; }
        
        .sub-btn { border: none; padding: 10px 20px; border-radius: 10px; font-weight: 900; cursor: pointer; font-size: 12px; }
        .sub-btn.active { background: var(--warn); color: white; }
        .sub-btn.inactive { background: var(--sub); color: black; }

        #harvester-status { position: fixed; bottom: 20px; right: 20px; font-size: 10px; font-family: 'JetBrains Mono'; color: var(--primary); display: flex; align-items: center; gap: 8px; }
        .dot { width: 6px; height: 6px; background: var(--primary); border-radius: 50%; animation: pulse 1.5s infinite; }

        @keyframes pulse { 0%, 100% { opacity: 0.3; } 50% { opacity: 1; } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<aside>
    <div class="logo" onclick="app.nav('/home')">DivTube</div>
    <nav>
        <div class="nav-item" id="link-home" onclick="app.nav('/home')">üì° Neural Feed</div>
        <div class="nav-item" id="link-history" onclick="app.nav('/history')">üìú History</div>
        <div class="nav-item" id="link-settings" onclick="app.nav('/settings')">‚öôÔ∏è AI Core</div>
    </nav>
</aside>

<div id="harvester-status"><div class="dot"></div> <span id="h-text">HARVESTER_IDLE</span></div>

<main>
    <section id="view-home" class="view">
        <input type="text" id="searchBox" placeholder="Inject Neural Intent..." style="width:100%; background:rgba(255,255,255,0.03); border:1px solid var(--border); color:white; padding:18px 30px; border-radius:100px; font-size:1rem; outline:none; margin-bottom: 2rem;" onkeydown="if(event.key==='Enter') app.search()">
        <div id="grid" class="video-grid"></div>
    </section>

    <section id="view-watch" class="view">
        <div id="theater-mount"></div>
        <div style="padding: 2rem 4rem; display:flex; justify-content:space-between; align-items:center;">
            <h1 id="t-title" style="margin:0; font-size:2rem; font-weight:900;"></h1>
            <button onclick="app.nav('/home')" style="background:var(--primary); color:white; border:none; padding:12px 30px; border-radius:10px; cursor:pointer; font-weight:800;">EXIT</button>
        </div>
    </section>

    <section id="view-history" class="view">
        <h1 style="font-weight:900; font-size:2.5rem;">History</h1>
        <div id="history-list"></div>
    </section>

    <section id="view-settings" class="view">
        <h1 style="font-weight:900; font-size:2.5rem;">AI Settings</h1>
        <div style="max-width: 600px; margin-top: 2rem; background:var(--card); padding:2rem; border-radius:24px; border:1px solid var(--border);">
            <label style="font-size:10px; font-weight:900; color:var(--primary);">YOUTUBE_API_KEY</label>
            <input type="password" id="ytKey" style="width:100%; background:#000; border:1px solid var(--border); color:white; padding:15px; border-radius:12px; margin:10px 0 20px 0;">
            <button onclick="app.saveKey()" style="background:var(--primary); color:white; border:none; padding:15px; border-radius:12px; font-weight:800; cursor:pointer; width:100%;">SYNC ENGINE</button>
        </div>
    </section>
</main>

<div id="modal-overlay" onclick="app.closeModal()">
    <div id="modal-content" onclick="event.stopPropagation()">
        <div style="display:flex; justify-content:space-between; align-items:flex-start;">
            <div>
                <h2 id="m-title" style="margin:0; color:var(--primary); font-size:2rem;"></h2>
                <div id="m-meta" style="font-size:12px; color:#555; margin-top:5px;"></div>
            </div>
            <div id="sub-mount"></div>
        </div>
        <p id="m-desc" style="font-size:14px; color:#999; line-height:1.6; margin-top:20px; background:rgba(255,255,255,0.03); padding:20px; border-radius:15px;"></p>
        <h3 style="margin-top:30px; font-size:12px; color:var(--accent); text-transform:uppercase;">Latest Uploads</h3>
        <div id="m-vids" style="display:grid; grid-template-columns:repeat(auto-fill, minmax(180px, 1fr)); gap:15px; margin-top:15px;"></div>
    </div>
</div>

<script type="py">
import json
from js import window

class SovereignAI:
    def rank(self, pool_json, brain_json):
        pool = json.loads(pool_json)
        brain = json.loads(brain_json)
        weights = brain.get("weights", {})
        subs = brain.get("subs", []) # List of channel IDs
        
        for v in pool:
            base_w = weights.get(v['channelId'], {"points": 1.0})['points']
            sub_bonus = 10.0 if v['channelId'] in subs else 0.0
            v['score'] = base_w + sub_bonus
            v['isSubbed'] = v['channelId'] in subs
            
        pool.sort(key=lambda x: x['score'], reverse=True)
        return json.dumps(pool)

engine = SovereignAI()
window.pyRanker = engine.rank
window.app.onEngineReady()
</script>

<script>
const CONFIG = { base: '/DivTube' };

const app = {
    db: JSON.parse(localStorage.getItem('div_v26')) || { 
        key: "", history: [], pool: [], brain: { weights: {}, subs: [] } 
    },
    engineReady: false,

    init() {
        document.getElementById('ytKey').value = this.db.key;
        window.onpopstate = () => this.route();
        this.route();
        setInterval(() => this.harvest(), 60000);
    },

    onEngineReady() { this.engineReady = true; this.route(); },
    nav(path) { window.history.pushState({}, "", CONFIG.base + path); this.route(); },

    route() {
        const path = window.location.pathname.replace(CONFIG.base, '') || '/home';
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active-view'));
        const target = document.getElementById(`view-${path.replace('/', '') === '' ? 'home' : path.replace('/', '')}`);
        if(target) target.classList.add('active-view');
        if(path === '/home' || path === '/') this.renderHome();
    },

    async harvest() {
        if (!this.db.key || this.db.brain.subs.length === 0) return;
        document.getElementById('h-text').innerText = "HARVESTING_POOL...";
        
        // Harvest from top 3 subs
        const targets = this.db.brain.subs.slice(0, 3);
        for (let cid of targets) {
            const res = await fetch(`https://www.googleapis.com/youtube/v3/search?part=snippet&channelId=${cid}&maxResults=5&order=date&type=video&key=${this.db.key}`);
            const data = await res.json();
            if(data.items) this.addToPool(data.items);
        }
        document.getElementById('h-text').innerText = "HARVESTER_IDLE";
        if (this.getCurrentPath() === '/home') this.renderHome();
    },

    async search() {
        const q = document.getElementById('searchBox').value;
        const res = await fetch(`https://www.googleapis.com/youtube/v3/search?part=snippet&q=${q}&maxResults=25&type=video&key=${this.db.key}`);
        const data = await res.json();
        this.addToPool(data.items);
        this.renderHome();
    },

    addToPool(items) {
        const newItems = items.map(i => ({ 
            id: i.id.videoId, channelId: i.snippet.channelId, channelTitle: i.snippet.channelTitle,
            title: i.snippet.title, thumb: i.snippet.thumbnails.high.url 
        }));
        this.db.pool = [...newItems, ...this.db.pool].slice(0, 100);
        this.save();
    },

    renderHome() {
        if (!this.engineReady || this.db.pool.length === 0) return;
        const ranked = JSON.parse(window.pyRanker(JSON.stringify(this.db.pool), JSON.stringify(this.db.brain)));
        const grid = document.getElementById('grid'); grid.innerHTML = "";
        ranked.forEach(v => {
            const c = document.createElement('div'); c.className = 'card';
            const badge = v.isSubbed ? `<div class="badge badge-sub">SUBSCRIBED</div>` : '';
            c.innerHTML = `
                ${badge}<img src="${v.thumb}" onclick="app.play('${v.id}', '${v.title.replace(/'/g, "\\'")}', '${v.channelId}')">
                <div style="padding:15px;" onclick="app.play('${v.id}', '${v.title.replace(/'/g, "\\'")}', '${v.channelId}')">
                    <div style="font-weight:800; font-size:13px; line-height:1.4;">${v.title}</div>
                    <div style="font-size:11px; color:var(--sub); margin-top:5px; font-weight:700;">${v.channelTitle}</div>
                </div>
                <div style="padding:10px; border-top:1px solid var(--border);"><button class="sub-btn inactive" style="width:100%;" onclick="app.openChannel('${v.channelId}')">CHANNEL INSIGHT</button></div>
            `;
            grid.appendChild(c);
        });
    },

    async openChannel(cid) {
        document.getElementById('modal-overlay').style.display = 'flex';
        const res = await fetch(`https://www.googleapis.com/youtube/v3/channels?part=snippet,statistics&id=${cid}&key=${this.db.key}`);
        const data = await res.json();
        const info = data.items[0].snippet;
        const isSubbed = this.db.brain.subs.includes(cid);

        document.getElementById('m-title').innerText = info.title;
        document.getElementById('m-meta').innerText = `${parseInt(data.items[0].statistics.subscriberCount).toLocaleString()} Subscribers`;
        document.getElementById('m-desc').innerText = info.description;
        document.getElementById('sub-mount').innerHTML = `
            <button class="sub-btn ${isSubbed ? 'active' : 'inactive'}" onclick="app.toggleSub('${cid}')">
                ${isSubbed ? 'UNSUBSCRIBE' : 'SUBSCRIBE'}
            </button>`;

        const vRes = await fetch(`https://www.googleapis.com/youtube/v3/search?part=snippet&channelId=${cid}&maxResults=8&order=date&type=video&key=${this.db.key}`);
        const vData = await vRes.json();
        const vStrip = document.getElementById('m-vids'); vStrip.innerHTML = "";
        vData.items.forEach(v => {
            const d = document.createElement('div'); d.style = "cursor:pointer; font-size:11px;";
            d.innerHTML = `<img src="${v.snippet.thumbnails.medium.url}" style="width:100%; border-radius:10px;"><div style="font-weight:700;margin-top:5px;">${v.snippet.title}</div>`;
            d.onclick = () => { this.closeModal(); this.play(v.id.videoId, v.snippet.title, cid); };
            vStrip.appendChild(d);
        });
    },

    toggleSub(cid) {
        const idx = this.db.brain.subs.indexOf(cid);
        if(idx > -1) this.db.brain.subs.splice(idx, 1);
        else this.db.brain.subs.push(cid);
        this.save();
        this.openChannel(cid); // Refresh UI
    },

    play(id, title, cid) {
        this.nav('/watch');
        document.getElementById('theater-mount').innerHTML = `<iframe class="theater-frame" src="https://www.youtube-nocookie.com/embed/${id}?autoplay=1" allowfullscreen></iframe>`;
        document.getElementById('t-title').innerText = title;
        this.db.history.unshift({id, title, thumb: `https://i.ytimg.com/vi/${id}/mqdefault.jpg`, timestamp: Date.now()});
        this.save();
    },

    closeModal() { document.getElementById('modal-overlay').style.display = 'none'; this.renderHome(); },
    saveKey() { this.db.key = document.getElementById('ytKey').value; this.save(); location.reload(); },
    save() { localStorage.setItem('div_v26', JSON.stringify(this.db)); }
};

window.app = app;
app.init();
</script>
</body>
</html>
