<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <title>DivTube Sovereign v14.0</title>
    
    <script type="module" src="https://pyscript.net/releases/2024.1.1/core.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&family=JetBrains+Mono&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #030508; --sidebar: #090b11; --card: #11141d;
            --primary: #8b5cf6; --text: #f1f5f9; --border: rgba(255,255,255,0.06);
            --accent: #10b981; --warn: #ef4444;
        }
        * { box-sizing: border-box; font-family: 'Inter', sans-serif; transition: 0.2s; }
        body { margin: 0; background: var(--bg); color: var(--text); display: flex; height: 100vh; overflow: hidden; }
        
        aside { width: 300px; background: var(--sidebar); border-right: 1px solid var(--border); padding: 1.5rem; display: flex; flex-direction: column; }
        .logo { font-weight: 900; font-size: 1.8rem; color: var(--primary); letter-spacing: -2px; cursor: pointer; margin-bottom: 2rem; }
        
        .nav-item { padding: 12px; border-radius: 12px; cursor: pointer; color: rgba(255,255,255,0.4); font-weight: 700; display: flex; align-items: center; gap: 10px; margin-bottom: 5px; font-size: 0.9rem; }
        .nav-item.active { background: rgba(139, 92, 246, 0.15); color: var(--primary); border: 1px solid rgba(139, 92, 246, 0.2); }

        .tag-pill { display: inline-block; padding: 4px 10px; background: #1a1f2e; border: 1px solid var(--primary); border-radius: 20px; font-size: 10px; margin: 2px; color: var(--primary); }
        .lock-status { font-size: 10px; color: var(--accent); font-weight: 800; margin-top: 10px; }

        main { flex: 1; overflow-y: auto; background: radial-gradient(circle at top right, #0d1117, #030508); }
        .page { display: none; padding: 3rem; animation: fadeIn 0.4s ease; }
        .active-page { display: block; }

        .video-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 2rem; }
        .card { background: var(--card); border-radius: 20px; overflow: hidden; border: 1px solid var(--border); cursor: pointer; }
        .card:hover { transform: translateY(-5px); border-color: var(--primary); box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        
        #ai-status { position: fixed; bottom: 20px; right: 20px; background: #000; padding: 10px 20px; border-radius: 50px; border: 1px solid var(--border); font-family: 'JetBrains Mono'; font-size: 10px; color: var(--accent); z-index: 2000; }
    </style>
</head>
<body>

<aside>
    <div class="logo" onclick="nav('home')">DivTube</div>
    
    <div style="margin-bottom:20px;">
        <div id="account-pill-container"></div>
        <button onclick="addAccount()" style="width:100%; border: 1px dashed #333; background:none; color:#555; padding:8px; border-radius:8px; font-size:10px; cursor:pointer; margin-top:10px;">+ NEW ACCOUNT BRAIN</button>
    </div>

    <div class="nav-item active" onclick="nav('home')">üì° Neural Feed</div>
    <div class="nav-item" onclick="nav('insights')">üß† Neural Map</div>
    <div class="nav-item" onclick="nav('settings')">‚öôÔ∏è AI Core</div>

    <div style="margin-top:auto; padding:15px; background:rgba(255,255,255,0.03); border-radius:15px;">
        <div style="font-size:11px; font-weight:900; color:#666;">TOPIC LOCKS</div>
        <div id="locked-tags-list"></div>
        <input type="text" id="tagInput" placeholder="+ add filter..." style="width:100%; background:none; border:none; border-bottom:1px solid #333; color:white; font-size:11px; padding:5px 0; outline:none;" onkeydown="if(event.key==='Enter') addLock()">
    </div>
</aside>

<div id="ai-status">NEURAL_INIT...</div>

<main>
    <div id="page-home" class="page active-page">
        <input type="text" id="searchBox" placeholder="Inject global intent..." style="width:100%; background:#000; border:1px solid var(--border); color:white; padding:18px 30px; border-radius:50px; margin-bottom:40px; font-size:1rem; outline:none;" onkeydown="if(event.key==='Enter') runAISearch()">
        <div id="grid" class="video-grid"></div>
    </div>

    <div id="page-insights" class="page">
        <h1>Neural Topography</h1>
        <div id="heatmap" style="width:100%; height:300px; background:#000; border-radius:20px; border:1px solid var(--border); margin-top:20px;"></div>
    </div>

    <div id="page-settings" class="page">
        <h1>AI Core Parameters</h1>
        <div style="background:var(--card); padding:2rem; border-radius:24px; border:1px solid var(--border);">
            <label style="font-size:11px; color:#555;">YOUTUBE_API_KEY</label>
            <input type="password" id="ytKey" style="width:100%; background:#000; border:1px solid var(--border); color:white; padding:12px; border-radius:10px; margin: 10px 0;">
            <button onclick="saveCore()" style="background:var(--primary); color:white; border:none; padding:12px 24px; border-radius:12px; font-weight:800; cursor:pointer;">SYNC CORE</button>
        </div>
    </div>

    <div id="page-watch" class="page">
        <button onclick="nav('home')" style="color:var(--primary); background:none; border:none; cursor:pointer; font-weight:800; margin-bottom:20px;">‚Üê CLOSE THEATER</button>
        <div id="theater-mount" style="aspect-ratio:16/9; background:#000; border-radius:24px; overflow:hidden;"></div>
        <div style="margin-top:20px; display:flex; justify-content:space-between; align-items:center;">
            <h1 id="t-title" style="margin:0;"></h1>
            <button id="like-btn" onclick="aiLearn()" style="background:#222; border:none; color:white; padding:12px 30px; border-radius:50px; cursor:pointer; font-weight:800;">üî• TRAIN MODEL</button>
        </div>
    </div>
</main>

<script type="py">
import json
from js import window

class SovereignAI:
    def __init__(self):
        self.lock_penalty = 0.0  # Zero out videos that don't match locks

    def rank(self, candidates_json, brain_json):
        candidates = json.loads(candidates_json)
        brain = json.loads(brain_json)
        
        weights = brain.get("weights", {})
        locks = [l.lower() for l in brain.get("locks", [])]

        for v in candidates:
            title = v['title'].lower()
            cid = v['channelId']
            
            # 1. Base Score from Channel Engagement
            score = weights.get(cid, {}).get('points', 1.0)
            
            # 2. Topic Lock Enforcement
            if locks:
                match = any(lock in title for lock in locks)
                if not match:
                    score = 0.01  # Massive penalty for non-locked topics
                else:
                    score *= 5.0  # Boost for locked topics
            
            v['score'] = score
            
        # 3. Final Neural Sort
        candidates.sort(key=lambda x: x['score'], reverse=True)
        return json.dumps(candidates)

engine = SovereignAI()
window.pyRanker = engine.rank
window.document.getElementById("ai-status").innerText = "NEURAL_ENGINE_READY"
</script>

<script>
let currentUser = localStorage.getItem('div_user_active') || 'Main';
let db = {};

function boot() {
    const raw = localStorage.getItem(`div_brain_${currentUser}`);
    db = raw ? JSON.parse(raw) : { vault: { key: "" }, brain: { weights: {}, locks: [] } };
    renderUI();
    nav('home');
}

function renderUI() {
    // Render Accounts
    const accContainer = document.getElementById('account-pill-container');
    accContainer.innerHTML = "";
    Object.keys(localStorage).filter(k => k.startsWith('div_brain_')).forEach(k => {
        const name = k.replace('div_brain_', '');
        const btn = document.createElement('button');
        btn.className = `nav-item ${name === currentUser ? 'active' : ''}`;
        btn.style.width = "100%";
        btn.innerText = `üß† ${name}`;
        btn.onclick = () => { currentUser = name; localStorage.setItem('div_user_active', name); boot(); };
        accContainer.appendChild(btn);
    });

    // Render Locked Tags
    const tagList = document.getElementById('locked-tags-list');
    tagList.innerHTML = "";
    db.brain.locks.forEach(tag => {
        const span = document.createElement('span');
        span.className = 'tag-pill';
        span.innerText = tag;
        span.onclick = () => removeLock(tag);
        tagList.appendChild(span);
    });
}

function addLock() {
    const val = document.getElementById('tagInput').value;
    if(val) {
        db.brain.locks.push(val);
        document.getElementById('tagInput').value = "";
        save(); renderUI();
    }
}

function removeLock(tag) {
    db.brain.locks = db.brain.locks.filter(t => t !== tag);
    save(); renderUI();
}

async function runAISearch() {
    const q = document.getElementById('searchBox').value;
    document.getElementById('ai-status').innerText = "AI_THINKING...";
    
    const r = await fetch(`https://www.googleapis.com/youtube/v3/search?part=snippet&q=${q}&maxResults=25&type=video&key=${db.vault.key}`);
    const d = await r.json();
    
    const prepared = d.items.map(i => ({
        id: i.id.videoId,
        channelId: i.snippet.channelId,
        title: i.snippet.title,
        thumb: i.snippet.thumbnails.medium.url
    }));

    const ranked = JSON.parse(window.pyRanker(JSON.stringify(prepared), JSON.stringify(db.brain)));
    
    const grid = document.getElementById('grid');
    grid.innerHTML = "";
    ranked.forEach(v => {
        const c = document.createElement('div');
        c.className = 'card';
        c.innerHTML = `<img src="${v.thumb}"><div style="padding:15px; font-weight:700; font-size:0.9rem;">${v.title}</div>`;
        c.onclick = () => openTheater(v);
        grid.appendChild(c);
    });
    document.getElementById('ai-status').innerText = "NEURAL_ENGINE_READY";
}

let activeVid;
function openTheater(v) {
    activeVid = v;
    nav('watch');
    document.getElementById('theater-mount').innerHTML = `<iframe src="https://www.youtube-nocookie.com/embed/${v.id}?autoplay=1&modestbranding=1" allowfullscreen></iframe>`;
    document.getElementById('t-title').innerText = v.title;
    
    const cid = v.channelId;
    if(!db.brain.weights[cid]) db.brain.weights[cid] = { points: 1.0 };
    db.brain.weights[cid].points += 0.5;
    save();
}

function aiLearn() {
    db.brain.weights[activeVid.channelId].points += 15.0;
    document.getElementById('like-btn').innerText = "üß† MODEL_TRAINED";
    save();
}

function nav(p) {
    document.querySelectorAll('.page').forEach(pg => pg.classList.remove('active-page'));
    document.getElementById(`page-${p}`).classList.add('active-page');
}

function save() { localStorage.setItem(`div_brain_${currentUser}`, JSON.stringify(db)); }
function saveCore() { db.vault.key = document.getElementById('ytKey').value; save(); location.reload(); }
function addAccount() { const n = prompt("New Brain Name:"); if(n) { currentUser = n; save(); boot(); } }

boot();
</script>
</body>
</html>
