<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <title>DivTube Sovereign v8.0</title>
    
    <script type="module" src="https://pyscript.net/releases/2024.1.1/core.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/universal-sentence-encoder" defer></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&family=JetBrains+Mono&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #030406; --sidebar: #080a0f; --card: #0f121a;
            --primary: #8b5cf6; --text: #f1f5f9; --border: rgba(255,255,255,0.06);
            --accent: #10b981; --error: #ef4444;
        }
        * { box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { margin: 0; background: var(--bg); color: var(--text); display: flex; height: 100vh; overflow: hidden; }
        
        /* Sidebar & Navigation */
        aside { width: 260px; background: var(--sidebar); border-right: 1px solid var(--border); padding: 1.5rem; display: flex; flex-direction: column; }
        .logo-box { display: flex; align-items: center; gap: 12px; margin-bottom: 40px; }
        .logo-box img { width: 32px; height: 32px; border-radius: 6px; }
        .logo-text { font-weight: 900; letter-spacing: -2px; font-size: 1.5rem; color: var(--primary); }

        .nav-item { 
            padding: 14px 18px; border-radius: 12px; cursor: pointer; transition: 0.2s; 
            margin-bottom: 8px; font-weight: 600; display: flex; align-items: center; gap: 12px;
            color: rgba(255,255,255,0.4);
        }
        .nav-item:hover { background: rgba(255,255,255,0.03); color: white; }
        .nav-item.active { background: rgba(139, 92, 246, 0.1); color: var(--primary); }

        /* Content Area */
        main { flex: 1; overflow-y: auto; position: relative; display: flex; flex-direction: column; }
        header { 
            padding: 1.5rem 3rem; background: rgba(3,4,6,0.8); backdrop-filter: blur(20px); 
            display: flex; gap: 20px; align-items: center; border-bottom: 1px solid var(--border);
            position: sticky; top: 0; z-index: 100;
        }
        #searchBox { 
            flex: 1; background: var(--card); border: 1px solid var(--border); padding: 14px 28px; 
            border-radius: 40px; color: white; outline: none; transition: 0.3s;
        }
        #searchBox:focus { border-color: var(--primary); box-shadow: 0 0 20px rgba(139, 92, 246, 0.15); }

        /* Pages */
        .page { display: none; padding: 3rem; width: 100%; max-width: 1600px; margin: 0 auto; }
        .active-page { display: block; }
        
        /* Video Grid */
        .video-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 2rem; }
        .card { 
            background: var(--card); border-radius: 20px; overflow: hidden; border: 1px solid var(--border); 
            transition: 0.4s; position: relative; cursor: pointer;
        }
        .card:hover { transform: translateY(-10px); border-color: var(--primary); }
        .card img { width: 100%; aspect-ratio: 16/9; object-fit: cover; }
        .source-pill { position: absolute; top: 15px; left: 15px; background: rgba(0,0,0,0.7); font-size: 10px; font-weight: 900; padding: 4px 10px; border-radius: 6px; text-transform: uppercase; }

        /* Settings View */
        .settings-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; }
        .settings-card { background: var(--card); padding: 2rem; border-radius: 24px; border: 1px solid var(--border); }
        .setting-group { margin-bottom: 2rem; }
        label { display: block; font-size: 12px; font-weight: 800; color: rgba(255,255,255,0.4); margin-bottom: 12px; text-transform: uppercase; }
        textarea, select, input[type="number"] { 
            width: 100%; background: #000; border: 1px solid var(--border); color: #fff; padding: 12px; border-radius: 10px; font-family: 'JetBrains Mono';
        }

        /* Loading & Infinite Scroll Indicator */
        #loader { text-align: center; padding: 40px; opacity: 0; transition: 0.3s; }
        #loader.visible { opacity: 1; }
    </style>
</head>
<body>

<aside>
    <div class="logo-box">
        <img src="image_6fdbfe.png" alt="Logo">
        <div class="logo-text">DivTube</div>
    </div>
    <div class="nav-item active" onclick="nav('home', this)"><span>üè†</span> Neural Feed</div>
    <div class="nav-item" onclick="nav('settings', this)"><span>‚öôÔ∏è</span> System Core</div>
    
    <div id="status" style="margin-top:auto; font-size: 10px; font-weight: 900; color: #444;">ENGINE_BOOT_PENDING</div>
</aside>

<main id="mainContainer">
    <header>
        <form onsubmit="initSearch(event)" style="display:contents">
            <input type="text" id="searchBox" placeholder="Inject global intent...">
        </form>
    </header>

    <div id="page-home" class="page active-page">
        <div id="grid" class="video-grid"></div>
        <div id="loader">Computing next cognitive batch...</div>
    </div>

    <div id="page-settings" class="page">
        <h1 style="margin-bottom: 2rem;">System Core Settings</h1>
        <div class="settings-grid">
            <div class="settings-card">
                <h3>Neural Optimizer</h3>
                <div class="setting-group">
                    <label>Discovery vs History Bias</label>
                    <input type="range" id="neuralMixer" min="0" max="100" value="70" style="width:100%; accent-color: var(--primary);">
                </div>
                <div class="setting-group">
                    <label>Similarity Threshold (0.0 - 1.0)</label>
                    <input type="number" id="simLimit" step="0.1" value="0.4">
                </div>
                <div class="setting-group">
                    <label>Engine Pruning</label>
                    <button onclick="localStorage.removeItem('sov_brain'); location.reload();" style="color:var(--error); background:none; border:none; cursor:pointer;">Wipe Neural Memory</button>
                </div>
            </div>

            <div class="settings-card">
                <h3>API Infrastructure</h3>
                <div class="setting-group">
                    <label>YouTube Key Pool (One per line)</label>
                    <textarea id="ytKeys" rows="5"></textarea>
                </div>
                <div class="setting-group">
                    <label>Vimeo Developer Token</label>
                    <input type="text" id="vimToken">
                </div>
                <button onclick="saveAllSettings()" style="background:var(--primary); color:white; border:none; padding:12px 24px; border-radius:12px; cursor:pointer; font-weight:800; width:100%;">Sync Infrastructure</button>
            </div>
        </div>
    </div>
</main>

<script type="py">
import json
from pyodide.ffi import create_proxy
from js import window

def process_ranking(v_json, b_json, mixer_val):
    vids, brain = json.loads(v_json), json.loads(b_json)
    mixer = float(mixer_val) / 100.0
    intents = brain.get('intents', {})
    
    for v in vids:
        v_vec = v.get('vector', [])
        # Vector Dot Product Sim
        scores = [sum(a*b for a,b in zip(v_vec, d['vector'])) * d.get('weight', 1) for d in intents.values()]
        v['score'] = (max(scores) * mixer) if scores else (0.5 * mixer)
    
    vids.sort(key=lambda x: x['score'], reverse=True)
    return json.dumps(vids)

window.pyRanker = create_proxy(process_ranking)
window.document.getElementById("status").innerText = "ENGINE_READY_V8"
</script>

<script>
let model, isFetching = false;
let currentQuery = "";
let tokens = { youtube: null, vimeo: 1 };
let state = {
    vault: JSON.parse(localStorage.getItem('sov_vault')) || { youtube: [], vimeo: "" },
    brain: JSON.parse(localStorage.getItem('sov_brain')) || { intents: {} }
};

async function initAI() {
    if (!model) {
        document.getElementById('status').innerText = "ENGINE_LOADING_MODELS";
        model = await use.load();
        document.getElementById('status').innerText = "ENGINE_ONLINE";
    }
}

// Infinite Scroll Logic
document.getElementById('mainContainer').addEventListener('scroll', async (e) => {
    const { scrollTop, scrollHeight, clientHeight } = e.target;
    if (scrollTop + clientHeight >= scrollHeight - 300 && !isFetching && currentQuery) {
        fetchNextBatch();
    }
});

async function initSearch(e) {
    if(e) e.preventDefault();
    currentQuery = document.getElementById('searchBox').value;
    document.getElementById('grid').innerHTML = "";
    tokens = { youtube: null, vimeo: 1 };
    fetchNextBatch();
}

async function fetchNextBatch() {
    isFetching = true;
    document.getElementById('loader').classList.add('visible');
    await initAI();

    const results = await fetchFromProviders(currentQuery);
    if(results.length === 0) { isFetching = false; return; }

    const embeds = await model.embed(results.map(r => r.title));
    const vecs = embeds.arraySync();
    const data = results.map((v, i) => ({ ...v, vector: vecs[i] }));

    const ranked = JSON.parse(window.pyRanker(JSON.stringify(data), JSON.stringify(state.brain), document.getElementById('neuralMixer').value));
    render(ranked);
    
    isFetching = false;
    document.getElementById('loader').classList.remove('visible');
}

async function fetchFromProviders(q) {
    let combined = [];
    // YouTube
    if(state.vault.youtube.length > 0) {
        const ytUrl = `https://www.googleapis.com/youtube/v3/search?part=snippet&q=${q}&maxResults=12&type=video&key=${state.vault.youtube[0]}${tokens.youtube ? `&pageToken=${tokens.youtube}` : ''}`;
        const r = await fetch(ytUrl);
        const d = await r.json();
        tokens.youtube = d.nextPageToken;
        combined.push(...d.items.map(i => ({ title: i.snippet.title, thumb: i.snippet.thumbnails.medium.url, link: `https://youtube.com/watch?v=${i.id.videoId}`, source: 'youtube' })));
    }
    return combined;
}

function render(items) {
    const grid = document.getElementById('grid');
    items.forEach(v => {
        const div = document.createElement('div');
        div.className = 'card';
        div.innerHTML = `<div class="source-pill">${v.source}</div><img src="${v.thumb}"><div style="padding:20px; font-weight:700;">${v.title}</div>`;
        div.onclick = () => window.open(v.link);
        grid.appendChild(div);
    });
}

function nav(page, el) {
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active-page'));
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
    document.getElementById(`page-${page}`).classList.add('active-page');
    el.classList.add('active');
    
    if(page === 'settings') {
        document.getElementById('ytKeys').value = state.vault.youtube.join('\n');
        document.getElementById('vimToken').value = state.vault.vimeo;
    }
}

function saveAllSettings() {
    state.vault.youtube = document.getElementById('ytKeys').value.split('\n').filter(k => k.trim());
    state.vault.vimeo = document.getElementById('vimToken').value.trim();
    localStorage.setItem('sov_vault', JSON.stringify(state.vault));
    alert("System Synced Successfully.");
}
</script>
</body>
</html>
