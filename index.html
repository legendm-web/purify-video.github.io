<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <title>DivTube Sovereign v31.0</title>
    <script type="module" src="https://pyscript.net/releases/2024.1.1/core.js" defer></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #010204; --sidebar: #06080c; --card: #0c0f16;
            --primary: #8b5cf6; --text: #f1f5f9; --border: rgba(255,255,255,0.06);
            --sub: #f59e0b; --warn: #ef4444;
        }
        * { box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { margin: 0; background: var(--bg); color: var(--text); display: flex; height: 100vh; overflow: hidden; }
        
        aside { width: 240px; background: var(--sidebar); border-right: 1px solid var(--border); padding: 1.5rem; display: flex; flex-direction: column; flex-shrink: 0; }
        .logo { font-weight: 900; font-size: 1.8rem; color: var(--primary); letter-spacing: -2px; cursor: pointer; margin-bottom: 2rem; }
        .nav-item { padding: 12px; border-radius: 12px; cursor: pointer; color: rgba(255,255,255,0.4); font-weight: 700; margin-bottom: 5px; text-decoration: none; display: block; }
        .nav-item.active { background: rgba(139, 92, 246, 0.1); color: var(--primary); }

        main { flex: 1; overflow-y: auto; background: radial-gradient(circle at top right, #0d1117, #010204); position: relative; }
        .view { display: none; padding: 2rem; animation: fadeIn 0.3s ease; }
        .active-view { display: block; }

        /* Grid & Thumbnails */
        .video-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1.5rem; }
        .card { background: var(--card); border-radius: 12px; overflow: hidden; border: 1px solid var(--border); transition: 0.2s; }
        .thumb-wrap { width: 100%; aspect-ratio: 16/9; overflow: hidden; position: relative; cursor: pointer; background: #000; }
        .thumb-wrap img { width: 100%; height: 100%; object-fit: cover; }
        
        /* Watch Page Fixes */
        .watch-layout { display: flex; gap: 2rem; max-width: 1700px; margin: 0 auto; padding-bottom: 50px; }
        .player-block { flex: 2.5; min-width: 0; }
        
        /* The Responsive 16:9 Theater Fix */
        .theater-mount-container { 
            position: relative; 
            width: 100%; 
            padding-top: 56.25%; /* 16:9 Aspect Ratio */
            background: #000; 
            border-radius: 16px; 
            overflow: hidden; 
            border: 1px solid var(--border);
        }
        .theater-mount-container iframe { 
            position: absolute; 
            top: 0; left: 0; 
            width: 100%; height: 100%; 
            border: none; 
        }

        .rec-block { flex: 1; display: flex; flex-direction: column; gap: 1rem; max-height: 90vh; overflow-y: auto; padding-right: 10px; min-width: 350px; }
        .rec-item { display: flex; gap: 12px; background: var(--card); padding: 10px; border-radius: 10px; cursor: pointer; border: 1px solid transparent; }
        .rec-item:hover { border-color: var(--primary); }
        .rec-thumb { width: 160px; aspect-ratio: 16/9; border-radius: 6px; object-fit: cover; flex-shrink: 0; }
        .rec-meta { display: flex; flex-direction: column; justify-content: flex-start; }

        /* Modal Overlay */
        #modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.92); backdrop-filter: blur(10px); display: none; z-index: 10000; align-items: center; justify-content: center; }
        #modal-content { background: var(--bg); width: 95%; max-width: 1100px; border-radius: 24px; border: 1px solid var(--border); padding: 2.5rem; max-height: 90vh; display: flex; flex-direction: column; }
        #m-vids-scroll { overflow-y: auto; flex: 1; margin-top: 20px; }
        
        #boot-screen { position: fixed; inset: 0; background: #000; z-index: 20000; display: flex; align-items: center; justify-content: center; font-weight: 900; color: var(--primary); font-size: 1.2rem; }
        .btn { padding: 10px 20px; border-radius: 8px; border: none; font-weight: 800; cursor: pointer; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

<div id="boot-screen">STABILIZING_GEOMETRY...</div>

<aside>
    <div class="logo" onclick="app.nav('/home')">DivTube</div>
    <a class="nav-item" id="link-home" onclick="app.nav('/home')">üì° Neural Feed</a>
    <a class="nav-item" id="link-settings" onclick="app.nav('/settings')">‚öôÔ∏è AI Core</a>
</aside>

<main>
    <section id="view-home" class="view">
        <input type="text" id="searchBox" placeholder="Inject Search Intent..." style="width:100%; background:rgba(255,255,255,0.03); border:1px solid var(--border); color:white; padding:18px; border-radius:12px; margin-bottom:2rem; outline:none;" onkeydown="if(event.key==='Enter') app.search()">
        <div id="grid" class="video-grid"></div>
    </section>

    <section id="view-watch" class="view">
        <div class="watch-layout">
            <div class="player-block">
                <div class="theater-mount-container" id="theater-mount">
                    </div>
                <h2 id="t-title" style="margin-top:25px; font-size:1.8rem; font-weight:900; line-height:1.2;"></h2>
            </div>
            <div class="rec-block" id="rec-sidebar"></div>
        </div>
    </section>

    <section id="view-settings" class="view">
        <h1 style="font-weight:900; font-size:2.5rem;">Core Config</h1>
        <div style="max-width:450px; background:var(--card); padding:2rem; border-radius:20px; border:1px solid var(--border);">
            <label style="font-size:11px; font-weight:900; color:var(--primary);">YOUTUBE_API_KEY</label>
            <input type="password" id="ytKey" style="width:100%; margin:15px 0; padding:15px; background:#000; border:1px solid var(--border); color:white; border-radius:10px;">
            <button class="btn" style="background:var(--primary); color:white; width:100%;" onclick="app.saveKey()">REBOOT SYSTEM</button>
        </div>
    </section>
</main>

<div id="modal-overlay" onclick="app.closeModal()">
    <div id="modal-content" onclick="event.stopPropagation()">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h2 id="m-title" style="margin:0; font-size:2rem; font-weight:900;"></h2>
            <div id="m-sub-area"></div>
        </div>
        <div id="m-vids-scroll">
            <div id="m-vids" style="display:grid; grid-template-columns:repeat(auto-fill, minmax(240px, 1fr)); gap:20px;"></div>
        </div>
    </div>
</div>

<script type="py">
import json
from js import window

class SovereignAI:
    def rank(self, pool_json, brain_json):
        pool = json.loads(pool_json)
        brain = json.loads(brain_json)
        subs = brain.get("subs", [])
        for v in pool:
            v['isSubbed'] = v['channelId'] in subs
            v['score'] = 1000 if v['isSubbed'] else 1
        pool.sort(key=lambda x: x['score'], reverse=True)
        return json.dumps(pool)

engine = SovereignAI()
window.pyRanker = engine.rank
window.app.onEngineReady()
</script>

<script>
const app = {
    basePath: window.location.pathname.startsWith('/DivTube') ? '/DivTube' : '',
    db: JSON.parse(localStorage.getItem('div_v31')) || { key: "", pool: [], brain: { subs: [] } },
    engineReady: false,

    init() {
        document.getElementById('ytKey').value = this.db.key;
        window.onpopstate = () => this.route();
        this.route();
    },

    onEngineReady() {
        this.engineReady = true;
        document.getElementById('boot-screen').style.display = 'none';
        this.renderHome();
    },

    nav(path) { 
        const target = this.basePath + path;
        window.history.pushState({}, "", target); 
        this.route(); 
    },

    route() {
        const fullPath = window.location.pathname;
        const route = fullPath.replace(this.basePath, '') || '/home';
        
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active-view'));
        document.querySelectorAll('.nav-item').forEach(v => v.classList.remove('active'));

        if (route.includes('settings')) {
            document.getElementById('view-settings').classList.add('active-view');
            document.getElementById('link-settings').classList.add('active');
        } else if (route.includes('watch')) {
            document.getElementById('view-watch').classList.add('active-view');
            this.renderRecommendations();
        } else {
            document.getElementById('view-home').classList.add('active-view');
            document.getElementById('link-home').classList.add('active');
            this.renderHome();
        }
    },

    async search() {
        const q = document.getElementById('searchBox').value;
        const res = await fetch(`https://www.googleapis.com/youtube/v3/search?part=snippet&q=${encodeURIComponent(q)}&maxResults=25&type=video&key=${this.db.key}`);
        const data = await res.json();
        const mapped = data.items.map(i => ({
            id: i.id.videoId, channelId: i.snippet.channelId, channelTitle: i.snippet.channelTitle,
            title: i.snippet.title.replace(/['"]/g, ""), thumb: i.snippet.thumbnails.high.url
        }));
        this.db.pool = [...mapped, ...this.db.pool].filter((v,i,a) => a.findIndex(t=>(t.id===v.id))===i).slice(0, 100);
        this.save();
        this.renderHome();
    },

    renderHome() {
        if (!this.engineReady || this.db.pool.length === 0) return;
        const ranked = JSON.parse(window.pyRanker(JSON.stringify(this.db.pool), JSON.stringify(this.db.brain)));
        document.getElementById('grid').innerHTML = ranked.map(v => `
            <div class="card">
                <div class="thumb-wrap" onclick="app.play('${v.id}', '${v.title}')">
                    <img src="${v.thumb}">
                </div>
                <div style="padding:15px;">
                    <div style="font-weight:800; font-size:14px; height:42px; overflow:hidden; line-height:1.4;">${v.title}</div>
                    <div style="color:var(--primary); font-size:11px; margin-top:10px; font-weight:900; cursor:pointer;" onclick="app.openChannel('${v.channelId}')">
                        ${v.channelTitle}
                    </div>
                </div>
            </div>
        `).join('');
    },

    async openChannel(cid) {
        document.getElementById('modal-overlay').style.display = 'flex';
        const res = await fetch(`https://www.googleapis.com/youtube/v3/channels?part=snippet&id=${cid}&key=${this.db.key}`);
        const data = await res.json();
        const info = data.items[0].snippet;
        const isSubbed = this.db.brain.subs.includes(cid);

        document.getElementById('m-title').innerText = info.title;
        document.getElementById('m-sub-area').innerHTML = `
            <button class="btn" style="background:${isSubbed ? 'var(--warn)' : 'var(--sub)'}; color:${isSubbed ? 'white' : 'black'};" onclick="app.toggleSub('${cid}')">
                ${isSubbed ? 'UNSUBSCRIBE' : 'SUBSCRIBE'}
            </button>`;

        const vRes = await fetch(`https://www.googleapis.com/youtube/v3/search?part=snippet&channelId=${cid}&maxResults=20&order=date&type=video&key=${this.db.key}`);
        const vData = await vRes.json();
        document.getElementById('m-vids').innerHTML = vData.items.map(v => `
            <div class="card" onclick="app.play('${v.id.videoId}', '${v.snippet.title.replace(/['"]/g, "")}')">
                <div class="thumb-wrap"><img src="${v.snippet.thumbnails.medium.url}"></div>
                <div style="padding:10px; font-size:12px; font-weight:800; height:45px; overflow:hidden;">${v.snippet.title}</div>
            </div>
        `).join('');
    },

    toggleSub(cid) {
        const idx = this.db.brain.subs.indexOf(cid);
        if (idx > -1) this.db.brain.subs.splice(idx, 1);
        else this.db.brain.subs.push(cid);
        this.save();
        this.openChannel(cid);
    },

    renderRecommendations() {
        const recs = this.db.pool.slice(0, 15);
        document.getElementById('rec-sidebar').innerHTML = recs.map(v => `
            <div class="rec-item" onclick="app.play('${v.id}', '${v.title}')">
                <img src="${v.thumb}" class="rec-thumb">
                <div class="rec-meta">
                    <div style="font-size:13px; font-weight:800; line-height:1.2; height:32px; overflow:hidden;">${v.title}</div>
                    <div style="font-size:11px; color:var(--primary); margin-top:4px;">${v.channelTitle}</div>
                </div>
            </div>
        `).join('');
    },

    play(id, title) {
        this.closeModal();
        this.nav('/watch');
        document.getElementById('theater-mount').innerHTML = `<iframe src="https://www.youtube-nocookie.com/embed/${id}?autoplay=1&rel=0&modestbranding=1" allowfullscreen></iframe>`;
        document.getElementById('t-title').innerText = title;
        window.scrollTo(0,0);
    },

    closeModal() { document.getElementById('modal-overlay').style.display = 'none'; this.renderHome(); },
    saveKey() { this.db.key = document.getElementById('ytKey').value; this.save(); location.reload(); },
    save() { localStorage.setItem('div_v31', JSON.stringify(this.db)); }
};

window.app = app;
app.init();
</script>
</body>
</html>
